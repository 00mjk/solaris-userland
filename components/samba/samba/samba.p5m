#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
# or http://www.opensolaris.org/os/licensing.
# See the License for the specific language governing permissions
# and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#
# Copyright (c) 2011, 2015, Oracle and/or its affiliates. All rights reserved.
#


<transform file path=usr.*/man/.+ -> default mangler.man.stability volatile>

# /etc/samba/private should not even be readable fo non-root users.
<transform dir path=etc/samba/private -> default mode 500>

# smbprofiles man
<transform file path=usr/share/man/man1/profiles.1 -> drop>

# General dirs generated in sample-manifest but with bad attribs.
<transform dir path=etc$ -> drop>
<transform dir file link path=opt.* -> drop>
<transform dir path=usr$ -> drop>
<transform dir path=usr/bin$ -> drop>
<transform dir path=usr/lib$ -> drop>
<transform dir path=usr/share$ -> drop>
<transform dir path=usr/share/doc$ -> drop>
<transform dir path=var$ -> drop>
<transform dir path=var/lib$ -> drop>

# Samba customized krb5-config
<transform file path=usr/bin/krb5-config -> drop>

# Remove the named files with strange deps breaking the pkglint
<transform file path=usr/lib/python2.7/vendor-packages/samba/samba/external/subunit/run.py -> drop>
<transform file path=usr/lib/python2.7/vendor-packages/samba/samba/external/subunit/run.pyc -> drop>
<transform file path=usr/lib/python2.7/vendor-packages/samba/samba/external/subunit/tests/sample-script.py -> drop>
<transform file path=usr/lib/python2.7/vendor-packages/samba/samba/external/subunit/tests/sample-script.pyc -> drop>

# Oracle HSM (SAMFS) is not yet supported on 12.0
#<transform file path=usr/lib/samba/vfs/samfs.so -> default pkg.depend.bypass-generate .*>
#<transform file path=usr/lib/samba/vfs/samfs.so -> default pkg.linted.userland.action001.3 true>

# Private API libgssapi_krb5.so.1 is not yet available in lint cache.
# Drop-In project will fix it
<transform file path=usr/lib/samba/$(MACH64)/libgensec.so.0 -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/$(MACH64)/libgensec.so.0 -> default pkg.linted.userland.action001.3 true>
<transform file path=usr/lib/samba/$(MACH64)/libsamba-credentials.so.0 -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/$(MACH64)/libsamba-credentials.so.0 -> default pkg.linted.userland.action001.3 true>
<transform file path=usr/lib/samba/libgensec.so.0.0.1 -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/libgensec.so.0.0.1 -> default pkg.linted.userland.action001.3 true>
<transform file path=usr/lib/samba/libsamba-credentials.so.0.0.1 -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/libsamba-credentials.so.0.0.1 -> default pkg.linted.userland.action001.3 true>
<transform file path=usr/lib/samba/private/libads.so -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/private/libads.so -> default pkg.linted.userland.action001.3 true>
<transform file path=usr/lib/samba/private/libgse.so -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/private/libgse.so -> default pkg.linted.userland.action001.3 true>

# mediated links macros to switch between Samba 3 and 4
<transform link target=.*/lib/samba/samba36/(s)?bin/.+ -> default mediator samba >
<transform link target=.*/lib/samba/samba36/(s)?bin/.+ -> default mediator-implementation 3 >
<transform link target=.*/lib/samba/samba36/(s)?bin/.+ -> default mediator-priority vendor >

<transform link target=.*/samba/samba36/lib/($(MACH64)/)?nss_.+\.so -> default mediator samba >
<transform link target=.*/samba/samba36/lib/($(MACH64)/)?nss_.+\.so -> default mediator-implementation 3 >
<transform link target=.*/samba/samba36/lib/($(MACH64)/)?nss_.+\.so -> default mediator-priority vendor >

<transform link target=.*/samba/samba36/lib/($(MACH64)/)?security/pam_.+\.so -> default mediator samba >
<transform link target=.*/samba/samba36/lib/($(MACH64)/)?security/pam_.+\.so -> default mediator-implementation 3 >
<transform link target=.*/samba/samba36/lib/($(MACH64)/)?security/pam_.+\.so -> default mediator-priority vendor >

<transform link target=.*/lib/samba/(s)?bin/.+ -> default mediator samba >
<transform link target=.*/lib/samba/(s)?bin/.+ -> default mediator-implementation 4 >

<transform link target=.*/samba/($(MACH64)/)?nss_.+\.so.* -> default mediator samba >
<transform link target=.*/samba/($(MACH64)/)?nss_.+\.so.* -> default mediator-implementation 4 >

<transform link target=.*/samba/$(MACH64)/pam_.+\.so -> default mediator samba >
<transform link target=.*/samba/security/pam_.+\.so -> default mediator samba >
<transform link target=.*/samba/$(MACH64)/pam_.+\.so -> default mediator-implementation 4 >
<transform link target=.*/samba/security/pam_.+\.so -> default mediator-implementation 4 >

# samba36 is not yet in pkg-repo ...can be removed after push
<transform file path=usr/lib/samba/samba36/.+ -> default pkg.depend.bypass-generate .*>
<transform file path=usr/lib/samba/samba36/.+ -> default pkg.linted.userland.action001.3 true>

# (motivation) Samba delivers dozens of objects so it is better to hanle it in
# two stages:
#  - machine genarated list of pkg objects (built as sample-manifest target)
#  - human edited part (smaller) which sets the attributes and handles the
#    exceptions.
#
# For the moment We also keep the original Samba 3.6 to provide transition path
# to Samba4. To separate Samba 3 and 4 files we keep them in two included
# files.
#
# "samba.proto-objects"-file is created using the command:
#   gmake sample-manifest METADATA_TEMPLATE=
# as a "sample-manifest"-file (in build/ dir) and is pkgfmt clean
# (because there is no template header placed on beginning of file)
# All individual actions and attribute settings on pkg objects should
# be performed by "<transform ...> (pkgmogrify) actions.
<include samba.proto-objects>
# "samba36.proto-objects"-file is created using the commands:
#   cd samba36/
#   gmake sample-manifest SAMBA36VER=3.6.25 METADATA_TEMPLATE=
# ...where sample-manifest"-file is created in ./samba36/build/ dir.
<include samba36.proto-objects>

# SMF services import (for .xml manifests)
<transform file path=lib/svc/manifest/.+\.xml -> default restart_fmri svc:/system/manifest-import:default >

# pkg attributes
set name=pkg.fmri \
    value=pkg:/service/network/samba@$(IPS_COMPONENT_VERSION),$(BUILD_VERSION)
set name=pkg.summary value="samba - A Windows SMB/CIFS fileserver for UNIX"
# In case of Samba 3.6 decomission uncomment com.oracle.info lines here
# and change the license record on the end of this file
# set name=com.oracle.info.description value="Samba, a SMB/CIFS fileserver"
# set name=com.oracle.info.tpno value=$(TPNO)
set name=info.classification \
    value="org.opensolaris.category.2008:System/File System"
set name=info.source-url value=$(COMPONENT_ARCHIVE_URL)
set name=info.upstream-url value=$(COMPONENT_PROJECT_URL)
set name=org.opensolaris.arc-caseid value=PSARC/2015/008
set name=org.opensolaris.consolidation value=$(CONSOLIDATION)

# pam.conf is now modularized using /etc/pam.d/ which is fine for adding of PAM-using services
# ...but add of new pam_-backend will need further fix.
# pam.conf-winbind is now obsoleted:
#file Solaris/pam.conf-winbind     path=etc/pam.d/

# samba confdir
dir  path=etc/samba/private mode=500
file examples/smb.conf.default path=etc/samba/smb.conf.default

# service manifests to install
file Solaris/samba.xml path=lib/svc/manifest/network/samba.xml
file Solaris/winbind.xml path=lib/svc/manifest/network/winbind.xml
file Solaris/wins.xml path=lib/svc/manifest/network/wins.xml
# service method
file Solaris/samba.sh path=lib/svc/method/samba

#
# bin (mediated links)
# Samba CLI (available on standard path) is now frozen (reduced) to original
# Samba 3.6 command-set to be able to handle thwse mediated links by a more
# programmatical way.
# (note) commented links documents the difference between the Samba 3.6 and
# Samba4 CLI. If the Samba4 utility is needed it should be called from its
# /usr/lib/samba/bin ...path.
#
#link path=usr/bin/cifsdd target=../lib/samba/bin/cifsdd target
#link path=usr/bin/dbwrap_tool target=../lib/samba/bin/dbwrap_tool
link path=usr/bin/eventlogadm target=../lib/samba/bin/eventlogadm
link path=usr/bin/eventlogadm target=../lib/samba/samba36/bin/eventlogadm
#link path=usr/bin/gentest target=../lib/samba/bin/gentest
#link path=usr/bin/ldbadd target=../lib/samba/bin/ldbadd
#link path=usr/bin/ldbdel target=../lib/samba/bin/ldbdel
#link path=usr/bin/ldbedit target=../lib/samba/bin/ldbedit
#link path=usr/bin/ldbmodify target=../lib/samba/bin/ldbmodify
#link path=usr/bin/ldbrename target=../lib/samba/bin/ldbrename
#link path=usr/bin/ldbsearch target=../lib/samba/bin/ldbsearch
#link path=usr/bin/locktest target=../lib/samba/bin/locktest
#link path=usr/bin/masktest target=../lib/samba/bin/masktest
#link path=usr/bin/ndrdump target=../lib/samba/bin/ndrdump
link path=usr/bin/net target=../lib/samba/bin/net
link path=usr/bin/net target=../lib/samba/samba36/bin/net
link path=usr/bin/nmblookup target=../lib/samba/bin/nmblookup
link path=usr/bin/nmblookup target=../lib/samba/samba36/bin/nmblookup
#link path=usr/bin/nmblookup4 target=../lib/samba/bin/nmblookup4
#link path=usr/bin/ntdbbackup target=../lib/samba/bin/ntdbbackup
#link path=usr/bin/ntdbdump target=../lib/samba/bin/ntdbdump
#link path=usr/bin/ntdbrestore target=../lib/samba/bin/ntdbrestore
#link path=usr/bin/ntdbtool target=../lib/samba/bin/ntdbtool
link path=usr/bin/ntlm_auth target=../lib/samba/bin/ntlm_auth
link path=usr/bin/ntlm_auth target=../lib/samba/samba36/bin/ntlm_auth
#link path=usr/bin/oLschema2ldif target=../lib/samba/bin/oLschema2ldif
link path=usr/bin/pdbedit target=../lib/samba/bin/pdbedit
link path=usr/bin/pdbedit target=../lib/samba/samba36/bin/pdbedit
#link path=usr/bin/pidl target=../lib/samba/bin/pidl
#link path=usr/bin/regdiff target=../lib/samba/bin/regdiff
#link path=usr/bin/regpatch target=../lib/samba/bin/regpatch
#link path=usr/bin/regshell target=../lib/samba/bin/regshell
#link path=usr/bin/regtree target=../lib/samba/bin/regtree
link path=usr/bin/rpcclient target=../lib/samba/bin/rpcclient
link path=usr/bin/rpcclient target=../lib/samba/samba36/bin/rpcclient
link path=usr/bin/sharesec target=../lib/samba/bin/sharesec
link path=usr/bin/sharesec target=../lib/samba/samba36/bin/sharesec
link path=usr/bin/smbcacls target=../lib/samba/bin/smbcacls
link path=usr/bin/smbcacls target=../lib/samba/samba36/bin/smbcacls
link path=usr/bin/smbclient target=../lib/samba/bin/smbclient
link path=usr/bin/smbclient target=../lib/samba/samba36/bin/smbclient
link path=usr/bin/smbcontrol target=../lib/samba/bin/smbcontrol
link path=usr/bin/smbcontrol target=../lib/samba/samba36/bin/smbcontrol
link path=usr/bin/smbcquotas target=../lib/samba/bin/smbcquotas
link path=usr/bin/smbcquotas target=../lib/samba/samba36/bin/smbcquotas
link path=usr/bin/smbget target=../lib/samba/bin/smbget
link path=usr/bin/smbget target=../lib/samba/samba36/bin/smbget
link path=usr/bin/smbpasswd target=../lib/samba/bin/smbpasswd
link path=usr/bin/smbpasswd target=../lib/samba/samba36/bin/smbpasswd
link path=usr/bin/smbprofiles target=../lib/samba/bin/profiles
link path=usr/bin/smbprofiles target=../lib/samba/samba36/bin/profiles
link path=usr/bin/smbspool target=../lib/samba/bin/smbspool
link path=usr/bin/smbspool target=../lib/samba/samba36/bin/smbspool
link path=usr/bin/smbstatus target=../lib/samba/bin/smbstatus
link path=usr/bin/smbstatus target=../lib/samba/samba36/bin/smbstatus
link path=usr/bin/smbta-util target=../lib/samba/bin/smbta-util
link path=usr/bin/smbta-util target=../lib/samba/samba36/bin/smbta-util
link path=usr/bin/smbtar target=../lib/samba/bin/smbtar
link path=usr/bin/smbtar target=../lib/samba/samba36/bin/smbtar
link path=usr/bin/smbtorture target=../lib/samba/bin/smbtorture
link path=usr/bin/smbtree target=../lib/samba/bin/smbtree
link path=usr/bin/smbtree target=../lib/samba/samba36/bin/smbtree
link path=usr/bin/tdbbackup target=../lib/samba/bin/tdbbackup
link path=usr/bin/tdbbackup target=../lib/samba/samba36/bin/tdbbackup
link path=usr/bin/tdbdump target=../lib/samba/bin/tdbdump
link path=usr/bin/tdbdump target=../lib/samba/samba36/bin/tdbdump
link path=usr/bin/tdbrestore target=../lib/samba/bin/tdbrestore
link path=usr/bin/tdbrestore target=../lib/samba/samba36/bin/tdbrestore
link path=usr/bin/tdbtool target=../lib/samba/bin/tdbtool
link path=usr/bin/tdbtool target=../lib/samba/samba36/bin/tdbtool
link path=usr/bin/testparm target=../lib/samba/bin/testparm
link path=usr/bin/testparm target=../lib/samba/samba36/bin/testparm
link path=usr/bin/wbinfo target=../lib/samba/bin/wbinfo
link path=usr/bin/wbinfo target=../lib/samba/samba36/bin/wbinfo

#
# nss_libs
link path=usr/lib/$(MACH64)/nss_winbind.so.1 \
    target=../samba/$(MACH64)/nss_winbind.so.1
link path=usr/lib/$(MACH64)/nss_winbind.so.1 \
    target=../samba/samba36/lib/$(MACH64)/nss_winbind.so
link path=usr/lib/nss_winbind.so.1 target=./samba/nss_winbind.so.1
link path=usr/lib/nss_winbind.so.1 target=./samba/samba36/lib/nss_winbind.so

# Private API libgssapi_krb5.so.1 is not yet available in lint cache.
# Drop-In project will fix it
file path=usr/lib/samba/$(MACH64)/libgssapi_krb5.so
file path=usr/lib/samba/libgssapi_krb5.so

#
# nss_libs files Samba 3.x do not deliver it by gmake install
# note: nss_wins.so is discontinued in Samba4
file samba36/build/$(MACH64)/nsswitch/libnss_winbind.so \
    path=usr/lib/samba/samba36/lib/$(MACH64)/nss_winbind.so
file samba36/build/$(MACH64)/nsswitch/libnss_wins.so \
    path=usr/lib/samba/samba36/lib/$(MACH64)/nss_wins.so
file samba36/build/$(MACH32)/nsswitch/libnss_winbind.so \
    path=usr/lib/samba/samba36/lib/nss_winbind.so
file samba36/build/$(MACH32)/nsswitch/libnss_wins.so \
    path=usr/lib/samba/samba36/lib/nss_wins.so

#
# PAM-libs
link path=usr/lib/security/$(MACH64)/pam_smbpass.so \
    target=../../samba/$(MACH64)/pam_smbpass.so
link path=usr/lib/security/$(MACH64)/pam_smbpass.so \
    target=../../samba/samba36/lib/$(MACH64)/security/pam_smbpass.so
link path=usr/lib/security/$(MACH64)/pam_smbpass.so.1 \
    target=../../samba/$(MACH64)/pam_smbpass.so
link path=usr/lib/security/$(MACH64)/pam_smbpass.so.1 \
    target=../../samba/samba36/lib/$(MACH64)/security/pam_smbpass.so
link path=usr/lib/security/$(MACH64)/pam_winbind.so \
    target=../../samba/$(MACH64)/pam_winbind.so
link path=usr/lib/security/$(MACH64)/pam_winbind.so \
    target=../../samba/samba36/lib/$(MACH64)/security/pam_winbind.so
link path=usr/lib/security/$(MACH64)/pam_winbind.so.1 \
    target=../../samba/$(MACH64)/pam_winbind.so
link path=usr/lib/security/$(MACH64)/pam_winbind.so.1 \
    target=../../samba/samba36/lib/$(MACH64)/security/pam_winbind.so
link path=usr/lib/security/pam_smbpass.so \
    target=../samba/samba36/lib/security/pam_smbpass.so
link path=usr/lib/security/pam_smbpass.so \
    target=../samba/security/pam_smbpass.so
link path=usr/lib/security/pam_smbpass.so.1 \
    target=../samba/samba36/lib/security/pam_smbpass.so
link path=usr/lib/security/pam_smbpass.so.1 \
    target=../samba/security/pam_smbpass.so
link path=usr/lib/security/pam_winbind.so \
    target=../samba/samba36/lib/security/pam_winbind.so
link path=usr/lib/security/pam_winbind.so \
    target=../samba/security/pam_winbind.so
link path=usr/lib/security/pam_winbind.so.1 \
    target=../samba/samba36/lib/security/pam_winbind.so
link path=usr/lib/security/pam_winbind.so.1 \
    target=../samba/security/pam_winbind.so

#
# sbin
# (note) SWAT is definitivelly gone in Samba4.
link path=usr/sbin/nmbd target=../lib/samba/samba36/sbin/nmbd
link path=usr/sbin/nmbd target=../lib/samba/sbin/nmbd
link path=usr/sbin/smbd target=../lib/samba/samba36/sbin/smbd
link path=usr/sbin/smbd target=../lib/samba/sbin/smbd
link path=usr/sbin/winbindd target=../lib/samba/samba36/sbin/winbindd
link path=usr/sbin/winbindd target=../lib/samba/sbin/winbindd

#
# smbprofiles
file usr/share/man/man1/profiles.1 path=usr/share/man/man1/smbprofiles.1

#
# dirs not created by install
dir  path=var/samba/com
dir  path=var/samba/locks
dir  path=var/samba/log
dir  path=var/spool/samba mode=1777

#
legacy pkg=SUNWsmbar \
    desc="samba - A Windows SMB/CIFS fileserver for UNIX (Root)" \
    name="samba - A Windows SMB/CIFS fileserver for UNIX (Root)"
legacy pkg=SUNWsmbau \
    desc="samba - A Windows SMB/CIFS fileserver for UNIX (Usr)" \
    name="samba - A Windows SMB/CIFS fileserver for UNIX (Usr)"

# in case of Samba 3.6 decomission remove all the lines following the next line
#  ...and uncomment the TPNO section in pkg-head (above)
license samba.license license=GPLv3 \
    com.oracle.info.description="Samba, a SMB/CIFS fileserver" \
    com.oracle.info.name=samba com.oracle.info.tpno=$(TPNO_SAMBA4) \
    com.oracle.info.version=$(COMPONENT_VERSION)
license samba36.license license=GPLv3 \
    com.oracle.info.description="Samba, a SMB/CIFS fileserver (deprecated)" \
    com.oracle.info.name=samba36 com.oracle.info.tpno=$(TPNO_SAMBA36) \
    com.oracle.info.version=$(SAMBA36VERSION)

# dependency can be removed later (after initial push)
depend type=require fmri=library/samba/libsmbclient

# Samba can be used in Asian multibyte language envs. so we need this
depend type=require fmri=pkg:/system/library/iconv
